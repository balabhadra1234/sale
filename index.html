<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Sales & Purchase — Firebase</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --accent: #2b7a78; --muted: #6b7280; --border: #e5e7eb; --bg: #f9fafb;
            --card-bg: #ffffff; --text: #111827; --shadow: rgba(15, 23, 42, 0.06);
        }
        [data-theme="dark"] {
            --accent: #14a8a5; --muted: #9ca3af; --border: #374151; --bg: #111827;
            --card-bg: #1f2937; --text: #f3f4f6; --shadow: rgba(0, 0, 0, 0.2);
        }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: background 0.3s ease; }
        header { background: var(--accent); color: white; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px var(--shadow); }
        .theme-toggle { background: transparent; border: none; cursor: pointer; color: white; font-size: 1.5rem; }
        main { padding: 16px; max-width: 1200px; margin: 0 auto; }
        nav { display: flex; gap: 8px; margin: 16px 0; border-radius: 12px; background-color: var(--card-bg); padding: 4px; box-shadow: var(--shadow); }
        nav button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; background: transparent; color: var(--muted); transition: all 0.2s ease; }
        nav button.active { background: var(--accent); color: white; box-shadow: 0 1px 2px var(--shadow); }
        .card { background: var(--card-bg); border-radius: 12px; padding: 16px; box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -2px var(--shadow); transition: background 0.3s ease; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-weight: 600; text-transform: uppercase; font-size: 0.8rem; color: var(--muted); }
        tr:last-child td { border-bottom: none; }
        .right { text-align: right; }
        .total-row td { font-weight: 600; color: var(--accent); border-top: 2px solid var(--border); }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-size: 0.9rem; font-weight: 500; }
        input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); }
        .btn { padding: 12px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn-danger { background: #ef4444; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: var(--card-bg); padding: 24px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; }
        .modal-buttons { display: flex; justify-content: space-between; gap: 8px; margin-top: 16px; }
        .toast-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 12px 20px; border-radius: 8px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        .stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 24px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--card-bg) 0%, #f0f0f0 100%);
            box-shadow: 0 8px 16px -4px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px -6px rgba(0,0,0,0.15), 0 6px 12px -3px rgba(0,0,0,0.1);
        }
        .stat-card .icon { font-size: 2rem; margin-bottom: 8px; color: var(--accent); }
        .stat-card .value { font-size: 2.25rem; font-weight: 700; }
        .stat-card .label { font-size: 0.9rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .error-message { text-align: center; padding: 20px; color: #ef4444; font-weight: bold; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <header>
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold">Sales & Purchase</h1>
            <span id="user-info" class="text-sm font-light italic"></span>
        </div>
        <div class="flex items-center gap-4">
            <button id="theme-toggle" class="theme-toggle">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                </svg>
            </button>
            <button id="export-data" class="bg-white text-black px-4 py-2 rounded-lg font-medium shadow-md">Export</button>
            <label class="bg-white text-black px-4 py-2 rounded-lg font-medium shadow-md cursor-pointer">
                Import
                <input type="file" id="import-file" class="hidden" accept=".json"/>
            </label>
        </div>
    </header>
    <main>
        <div id="status-message" class="text-center p-4">
            <div id="loader" class="loader mx-auto"></div>
            <p id="status-text" class="mt-2 text-gray-500">Connecting to Firebase...</p>
        </div>
        <nav id="navbar" class="hidden"></nav>
        <div id="app-container" class="hidden"></div>
    </main>
    <div id="modal-container"></div>
    <div id="toast" class="toast-message"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let data = {
            sales: [],
            purchases: [],
            customers: [],
            suppliers: []
        };
        let activePage = 'dashboard';
        let unsubscribe;

        // ========== UTILITY FUNCTIONS ==========
        const fmt = (n) => (n || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 3000);
        };
        const showModal = (message, onConfirm) => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content card">
                        <p>${message}</p>
                        <div class="modal-buttons">
                            <button id="modal-cancel" class="btn btn-secondary flex-1">Cancel</button>
                            <button id="modal-confirm" class="btn btn-danger flex-1">Confirm</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.querySelector('#modal-cancel').onclick = () => { modalContainer.innerHTML = ''; };
            modalContainer.querySelector('#modal-confirm').onclick = () => {
                onConfirm();
                modalContainer.innerHTML = '';
            };
        };
        const showStatus = (message, isLoading = true, isError = false) => {
            const statusContainer = document.getElementById('status-message');
            const loader = document.getElementById('loader');
            const statusText = document.getElementById('status-text');
            const appContainer = document.getElementById('app-container');
            const navbar = document.getElementById('navbar');

            statusText.textContent = message;
            statusContainer.style.display = 'block';

            if (isLoading) {
                loader.style.display = 'block';
                statusText.style.color = '#6b7280';
            } else {
                loader.style.display = 'none';
                if (isError) {
                    statusText.style.color = '#ef4444';
                } else {
                    statusText.style.color = '#2b7a78';
                }
            }

            if (isLoading || isError) {
                appContainer.classList.add('hidden');
                navbar.classList.add('hidden');
            } else {
                appContainer.classList.remove('hidden');
                navbar.classList.remove('hidden');
                statusContainer.style.display = 'none';
            }
        };

        // ========== FIREBASE SETUP & DATA HANDLING ==========
        const DATA_DOC_PATH = (uid) => `artifacts/${appId}/users/${uid}/appData/data`;

        /**
         * Initializes Firebase and authenticates the user.
         * The onAuthStateChanged listener will handle fetching data once authenticated.
         */
        const initFirebase = async () => {
            try {
                showStatus("Connecting to Firebase...");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `User ID: ${userId}`;
                        startFirestoreListener();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Authentication failed:", e);
                            showStatus("Authentication failed. Please try again.", false, true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus("Failed to initialize app. Check the console for details.", false, true);
            }
        };

        /**
         * Sets up a real-time listener for the user's data in Firestore.
         */
        const startFirestoreListener = () => {
            if (unsubscribe) {
                unsubscribe();
            }

            const docRef = doc(db, DATA_DOC_PATH(userId));
            unsubscribe = onSnapshot(docRef, (docSnap) => {
                showStatus("Data synced!", false, false);
                if (docSnap.exists()) {
                    data = docSnap.data();
                } else {
                    setDoc(doc(db, DATA_DOC_PATH(userId)), {
                        sales: [],
                        purchases: [],
                        customers: [],
                        suppliers: []
                    }).catch(err => console.error("Error initializing data:", err));
                }
                render(activePage);
            }, (error) => {
                console.error("Error getting Firestore data:", error);
                showStatus("Failed to fetch data from the cloud.", false, true);
            });
        };

        let saveTimeout;
        const saveData = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                if (userId) {
                    try {
                        const docRef = doc(db, DATA_DOC_PATH(userId));
                        await setDoc(docRef, data, { merge: true });
                    } catch (e) {
                        console.error("Error writing document: ", e);
                        showToast("Error saving data to the cloud.");
                    }
                }
            }, 500);
        };

        // ========== EXPORT/IMPORT FUNCTIONS ==========
        document.getElementById('export-data').onclick = async () => {
            if (!userId) {
                showToast("Authentication not ready. Please wait.");
                return;
            }
            try {
                const docRef = doc(db, DATA_DOC_PATH(userId));
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const jsonData = JSON.stringify(docSnap.data(), null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sales_data_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Data export successful!');
                } else {
                    showToast('No data to export.');
                }
            } catch (err) {
                console.error("Export failed:", err);
                showToast('Export failed. Check console for details.');
            }
        };

        document.getElementById('import-file').onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showModal('Are you sure? This will permanently delete all your current data and replace it with the data from the file.', () => {
                const reader = new FileReader();
                reader.onload = async e => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!userId) {
                            showToast("Authentication not ready. Please wait.");
                            return;
                        }
                        await setDoc(doc(db, DATA_DOC_PATH(userId)), importedData);
                        showToast('Data successfully imported!');
                        render(activePage);
                    } catch (err) {
                        showToast('Import failed: Could not parse the file.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            });
        };

        // ========== APP STATE AND RENDERING ==========
        const appContainer = document.getElementById('app-container');
        const navbar = document.getElementById('navbar');

        function render(page) {
            activePage = page;
            const pages = {
                dashboard: renderDashboard,
                sales: renderSales,
                purchases: renderPurchases,
                customers: renderCustomers,
                suppliers: renderSuppliers,
            };

            const navItems = Object.keys(pages).map(p => `
                <button class="nav-btn ${p === activePage ? 'active' : ''}" data-page="${p}">${p.charAt(0).toUpperCase() + p.slice(1)}</button>
            `).join('');
            navbar.innerHTML = navItems;
            navbar.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => render(btn.dataset.page);
            });

            if (pages[page]) {
                appContainer.innerHTML = pages[page]();
                const form = appContainer.querySelector('form');
                if (form) {
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const formData = new FormData(form);
                        const newEntry = {};
                        formData.forEach((value, key) => newEntry[key] = value);
                        if (page === 'sales' || page === 'purchases') {
                            newEntry.total = parseFloat(newEntry.total) || 0;
                            newEntry.paid = parseFloat(newEntry.paid) || 0;
                        }
                        newEntry.id = Date.now().toString();

                        data[page].push(newEntry);
                        saveData();
                        form.reset();
                        showToast(`${page.charAt(0).toUpperCase() + page.slice(1)} added!`);
                    };
                }
            }
        }

        function renderDashboard() {
            const totalSales = data.sales.reduce((sum, s) => sum + (parseFloat(s.total) || 0), 0);
            const totalPurchases = data.purchases.reduce((sum, p) => sum + (parseFloat(p.total) || 0), 0);
            const totalReceivables = data.sales.reduce((sum, s) => sum + ((parseFloat(s.total) || 0) - (parseFloat(s.paid) || 0)), 0);
            const totalPayables = data.purchases.reduce((sum, p) => sum + ((parseFloat(p.total) || 0) - (parseFloat(p.paid) || 0)), 0);
            const netProfit = totalSales - totalPurchases;

            const recentSales = [...data.sales].slice(-5).reverse();
            const recentPurchases = [...data.purchases].slice(-5).reverse();

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div class="stat-card">
                        <div class="icon text-green-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        </div>
                        <div class="value text-green-600">₹ ${fmt(totalSales)}</div>
                        <div class="label">Total Sales</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        </div>
                        <div class="value text-red-600">₹ ${fmt(totalPurchases)}</div>
                        <div class="label">Total Purchases</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        </div>
                        <div class="value text-blue-600">₹ ${fmt(totalReceivables)}</div>
                        <div class="label">Total Receivables</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon text-purple-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        </div>
                        <div class="value text-purple-600">₹ ${fmt(totalPayables)}</div>
                        <div class="label">Total Payables</div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <h3 class="text-2xl font-semibold mb-2 text-center">Net Profit</h3>
                    <p class="text-5xl font-extrabold text-center ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}">₹ ${fmt(netProfit)}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-2">Recent Sales</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th><th>Bill #</th><th>Customer</th><th class="right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentSales.map(s => {
                                        const cust = data.customers.find(c => c.id === s.customerId)?.name || 'N/A';
                                        return `<tr>
                                            <td>${s.date}</td>
                                            <td>${s.bill}</td>
                                            <td>${cust}</td>
                                            <td class="right">₹ ${fmt(s.total)}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold mb-2">Recent Purchases</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th><th>Bill #</th><th>Supplier</th><th class="right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentPurchases.map(p => {
                                        const sup = data.suppliers.find(s => s.id === p.supplierId)?.name || 'N/A';
                                        return `<tr>
                                            <td>${p.date}</td>
                                            <td>${p.bill}</td>
                                            <td>${sup}</td>
                                            <td class="right">₹ ${fmt(p.total)}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSales() {
            const receivables = data.sales.filter(s => (parseFloat(s.total) || 0) > (parseFloat(s.paid) || 0));
            const totalReceivables = receivables.reduce((sum, s) => sum + ((parseFloat(s.total) || 0) - (parseFloat(s.paid) || 0)), 0);

            return `
                <div class="card mb-4">
                    <h2 class="text-xl font-semibold mb-4">Add New Sale</h2>
                    <form>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Bill #</label>
                                <input type="text" name="bill" placeholder="Invoice Number" required>
                            </div>
                            <div class="form-group">
                                <label>Customer</label>
                                <select name="customerId" required>
                                    <option value="">Select Customer</option>
                                    ${data.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Total Amount</label>
                                <input type="number" name="total" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>Amount Paid</label>
                                <input type="number" name="paid" step="0.01" placeholder="0.00" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">Add Sale</button>
                    </form>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Receivables</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bill #</th>
                                    <th>Customer</th>
                                    <th class="right">Total</th>
                                    <th class="right">Paid</th>
                                    <th class="right">Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${receivables.map(s => {
                                    const cust = data.customers.find(c => c.id === s.customerId)?.name || 'N/A';
                                    const due = (parseFloat(s.total) || 0) - (parseFloat(s.paid) || 0);
                                    return `<tr>
                                        <td>${s.date}</td>
                                        <td>${s.bill}</td>
                                        <td>${cust}</td>
                                        <td class="right">₹ ${fmt(s.total)}</td>
                                        <td class="right">₹ ${fmt(s.paid)}</td>
                                        <td class="right" style="color:#ef4444">₹ ${fmt(due)}</td>
                                    </tr>`;
                                }).join('')}
                                <tr class="total-row">
                                    <td colspan="5" class="right">Total Receivables</td>
                                    <td class="right">₹ ${fmt(totalReceivables)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderPurchases() {
            const payables = data.purchases.filter(p => (parseFloat(p.total) || 0) > (parseFloat(p.paid) || 0));
            const totalPayables = payables.reduce((sum, p) => sum + ((parseFloat(p.total) || 0) - (parseFloat(p.paid) || 0)), 0);

            return `
                <div class="card mb-4">
                    <h2 class="text-xl font-semibold mb-4">Add New Purchase</h2>
                    <form>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group">
                                <label>Date</label>
                                <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Bill #</label>
                                <input type="text" name="bill" placeholder="Bill Number" required>
                            </div>
                            <div class="form-group">
                                <label>Supplier</label>
                                <select name="supplierId" required>
                                    <option value="">Select Supplier</option>
                                    ${data.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Total Amount</label>
                                <input type="number" name="total" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label>Amount Paid</label>
                                <input type="number" name="paid" step="0.01" placeholder="0.00" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">Add Purchase</button>
                    </form>
                </div>

                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Payables</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bill #</th>
                                    <th>Supplier</th>
                                    <th class="right">Total</th>
                                    <th class="right">Paid</th>
                                    <th class="right">Due</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${payables.map(p => {
                                    const sup = data.suppliers.find(s => s.id === p.supplierId)?.name || 'N/A';
                                    const due = (parseFloat(p.total) || 0) - (parseFloat(p.paid) || 0);
                                    return `<tr>
                                        <td>${p.date}</td>
                                        <td>${p.bill}</td>
                                        <td>${sup}</td>
                                        <td class="right">₹ ${fmt(p.total)}</td>
                                        <td class="right">₹ ${fmt(p.paid)}</td>
                                        <td class="right" style="color:#ef4444">₹ ${fmt(due)}</td>
                                    </tr>`;
                                }).join('')}
                                <tr class="total-row">
                                    <td colspan="5" class="right">Total Payables</td>
                                    <td class="right">₹ ${fmt(totalPayables)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderCustomers() {
            const renderCustomerList = () => {
                return `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.customers.map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.contact}</td>
                                        <td><button class="btn btn-danger btn-sm" onclick="deleteEntry('customers', '${c.id}')">Delete</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            return `
                <div class="card mb-4">
                    <h2 class="text-xl font-semibold mb-4">Add New Customer</h2>
                    <form>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" name="name" placeholder="Customer Name" required>
                            </div>
                            <div class="form-group">
                                <label>Contact Info</label>
                                <input type="text" name="contact" placeholder="Email or Phone">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">Add Customer</button>
                    </form>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Customer List</h2>
                    ${renderCustomerList()}
                </div>
            `;
        }

        function renderSuppliers() {
            const renderSupplierList = () => {
                return `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.suppliers.map(s => `
                                    <tr>
                                        <td>${s.name}</td>
                                        <td>${s.contact}</td>
                                        <td><button class="btn btn-danger btn-sm" onclick="deleteEntry('suppliers', '${s.id}')">Delete</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            };

            return `
                <div class="card mb-4">
                    <h2 class="text-xl font-semibold mb-4">Add New Supplier</h2>
                    <form>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" name="name" placeholder="Supplier Name" required>
                            </div>
                            <div class="form-group">
                                <label>Contact Info</label>
                                <input type="text" name="contact" placeholder="Email or Phone">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">Add Supplier</button>
                    </form>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Supplier List</h2>
                    ${renderSupplierList()}
                </div>
            `;
        }

        // Global functions for delete button access from rendered HTML
        window.deleteEntry = (type, id) => {
            showModal(`Are you sure you want to delete this ${type.slice(0, -1)}?`, () => {
                data[type] = data[type].filter(entry => entry.id !== id);
                saveData();
                showToast(`Entry deleted from ${type}!`);
            });
        };

        // ========== THEME TOGGLE ==========
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.onclick = () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        // ========== APP INITIALIZATION ==========
        (function init() {
            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
            initFirebase();
        })();
    </script>
</body>
</html>
